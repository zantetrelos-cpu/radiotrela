<!DOCTYPE html>
<html lang="el">
<head>
<title></title>
 <meta charset="utf-8">

<link rel="shortcut icon" href="zante.ico">
<style>
  body{margin:0;font-family:Segoe UI,Arial,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden;background:100% 100%}
 
  /* POPUP MODAL CSS */
  #loadingModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.8);
    align-items: center; justify-content: center;
  }
  .modal-content {
    background: rgba(20, 20, 20, 0.9);
    padding: 30px;
    border: 2px solid #00ffcc;
    border-radius: 15px;
    color: #00ffcc;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 0 30px #00ffcc;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* Ο ΚΥΚΛΟΣ ΠΑΡΑΜΕΝΕΙ ΣΤΟ ΚΕΝΤΡΟ ΜΕ ΤΑ ΧΡΩΜΑΤΑ ΤΟΥ */
  .player-btn{
    width:180px;height:180px;border-radius:50%;border:4px solid #00ffcc;
    background: rgba(0, 0, 0, 0.0) url('radio.png') center/cover no-repeat;
    color:#00ffcc;font-size:20px;display:flex;align-items:flex-end;justify-content:center;
    position:absolute;top:40px;z-index:5;
    transition:transform .12s linear, box-shadow .12s linear, border-color .12s linear;
    text-shadow:0 0 8px #00ffcc;font-weight:bold;padding-bottom:10px;
    --glow-r: 0;--glow-g: 255;--glow-b: 204;--glow-alpha: 0.18;--glow-size: 20px;
    border-color: rgba(var(--glow-r),var(--glow-g),var(--glow-b),1);
    box-shadow: 0 0 var(--glow-size) rgba(var(--glow-r),var(--glow-g),var(--glow-b),var(--glow-alpha)), 0 0 calc(var(--glow-size) / 3) rgba(var(--glow-r),var(--glow-b),calc(var(--glow-alpha) * .6));
  }

  /* ΤΟ ΜΠΟΥΤΟΝ ΕΛΕΓΧΟΥ ΠΑΕΙ ΠΑΝΩ ΔΕΞΙΑ - ΧΩΡΙΣ ΝΑ ΧΑΛΑΕΙ ΤΟΝ ΚΥΚΛΟ */
  #playBtn {
    position: absolute; top: 20px; right: 20px;
    width: 100px; height: 45px; border-radius: 8px;
    border: 2px solid #00ffcc; background: rgba(0, 0, 0, 0.5);
    color: #00ffcc; cursor: pointer; font-weight: bold; z-index: 100;
    box-shadow: 0 0 15px #00ffcc; display: flex; align-items: center; justify-content: center;
  }
 
  #status{position:absolute;top:270px;font-weight:700;letter-spacing:1px;font-size:30px; z-index:6;}
  .onair{color:#00ff99;text-shadow:0 0 10px #00ff99}
  .offair{color:#ff6600;text-shadow:0 0 12px #ff6600}
  .loading{color:#ffaa00;text-shadow:0 0 10px #ffaa00}
  
  #equalizer{position:absolute;bottom:0;width:100%;height:100vh;z-index:1}
  
  #nowPlaying{position:absolute;top:380px;font-size:24px;color:#fff;text-shadow:0 0 8px #ffff00;max-width:100%;text-align:center;z-index:4}

  #volumeControl {
    position: absolute;top: 330px;left: 50%;transform: translateX(-50%);
    display: flex;align-items: center;gap: 10px;z-index: 5;
  }
  #volumeSlider {Width: 250px;height: 5px;appearance: none;background: #333;border-radius: 5px;outline: none;box-shadow: 0 0 10px #00ffcc;}
  #volumeSlider::-webkit-slider-thumb {appearance: none;width: 18px;height: 18px;border-radius: 50%;background: #00ffcc;cursor: pointer;box-shadow: 0 0 10px #00ffcc;}
  #volumeValue {font-size: 18px;color: #00ffcc;text-shadow: 0 0 8px #00ffcc;width: 50px;text-align: left;}

  #effectBtn {
    position: absolute;top: 15px;left: 15px;width: 60px;height: 60px;
    background: rgba(0, 255, 204, 0.3);border: 3px solid #00ffcc;border-radius: 50%;
    display: flex;align-items: center;justify-content: center;cursor: pointer;z-index: 100;
    font-weight: bold;font-size: 18px;color: white;text-shadow: 0 0 10px #00ffcc;
    box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);transition: all 0.2s ease;
  }
  body::after {content: "";position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.7);z-index: -1;}
</style>
</head>
<body>

<div id="loadingModal">
  <div class="modal-content" id="modalText">Φόρτωση...</div>
</div>

<canvas id="equalizer"></canvas>
<div class="player-btn" id="visualizerCircle"></div>
<div id="playBtn">Play</div>

<div id="status" class="offair">Πάτησε Play</div>
<div id="nowPlaying">RADIO EROTAS LIVE</div>

<div id="volumeControl">
  <input type="range" id="volumeSlider" min="0" max="100" value="100">
  <span id="volumeValue">100%</span>
</div>

<div id="effectBtn">Bars</div>

<script>                                        
const STREAMS = {
  live: { name: "ΚΥΡΙΟΣ ΣΕΡΒΕΡ", streamUrl: "https://giss.tv:667/radiotrela.mp3", statusUrl: "https://giss.tv:667/status-json.xsl?mount=/radiotrela.mp3" },
  backup: { name: "BACKUP ΣΕΡΒΕΡ", streamUrl: "https://stream.zeno.fm/x8gduy6xd48uv", zenoStationId: "x8gduy6xd48uv", zenoMetaUrl: (id) => `https://api.zeno.fm/mounts/metadata/subscribe/${id}` }
};

const originalRadioName = "RADIO EROTAS LIVE";

let audio = new Audio(); audio.crossOrigin = "anonymous";
let audioCtx, analyser, dataArray, bufferLength, sourceNode;
let isPlaying = false, isLive = true, retryIntervalMs = 60000;

const btn = document.getElementById('playBtn');
const visualizerCircle = document.getElementById('visualizerCircle');
const statusEl = document.getElementById('status');
const nowPlayingEl = document.getElementById('nowPlaying');
const canvas = document.getElementById('equalizer');
const ctx = canvas.getContext('2d');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValue = document.getElementById('volumeValue');
const effectBtn = document.getElementById('effectBtn');

// ΣΤΟΙΧΕΙΑ ΓΙΑ ΤΟ MODAL
const loadingModal = document.getElementById('loadingModal');
const modalText = document.getElementById('modalText');

function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function setupAudioNodes(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioCtx.createMediaElementSource(audio);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);
  drawEqualizer();
  startButtonBreath();
}

const effects = [
  (ctx, data, w, h) => {
    const barWidth = (w / bufferLength) * 2.5;
    let x = 0;
    for(let i = 0; i < bufferLength; i++){
      const barHeight = data[i] * 0.65;
      ctx.fillStyle = `hsla(${(i * 5 + barHeight) % 360}, 100%, ${50 + barHeight / 5}%, 0.4)`;
      ctx.fillRect(x, h - barHeight, barWidth, barHeight);
      x += barWidth + 1;
    }
  },
  (ctx, data, w, h) => {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
    ctx.fillRect(0, 0, w, h);
    let total = 0;
    for(let i = 0; i < bufferLength; i++) total += data[i];
    const avg = total / bufferLength / 255;
    const starCount = 80 + Math.floor(avg * 200);
    const time = Date.now() * 0.002;
    for(let i = 0; i < starCount; i++){
      const x = (i * 131.7 + time * 50) % w;
      const y = (i * 89.3 + time * 30) % h;
      const size = 1 + Math.sin(time * 5 + i) * avg * 4;
      const opacity = 0.4 + avg * 0.6;
      const hue = (i * 7 + time * 100) % 360;
      ctx.shadowBlur = 15 + avg * 25;
      ctx.shadowColor = `hsla(${hue}, 100%, 80%, ${opacity})`;
      ctx.fillStyle = `hsla(${hue}, 100%, 95%, ${opacity})`;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.shadowBlur = 0;
  }
];

let currentEffect = 0;
function drawEqualizer(){
  requestAnimationFrame(drawEqualizer);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  effects[currentEffect](ctx, dataArray, canvas.width, canvas.height);
}

effectBtn.addEventListener('click', () => {
  currentEffect = currentEffect === 0 ? 1 : 0;
  effectBtn.textContent = currentEffect === 0 ? "Bars" : "★";
});

volumeSlider.addEventListener('input', () => {
  audio.volume = volumeSlider.value / 100;
  volumeValue.textContent = `${volumeSlider.value}%`;
});

function decodeGreek(str){
  try{
    const decoder = new TextDecoder('windows-1253');
    const bytes = new Uint8Array([...str].map(c => c.charCodeAt(0)));
    return decoder.decode(bytes);
  } catch(e){ return str; }
}

async function fetchLiveTitle(){
  try{
    const r = await fetch(STREAMS.live.statusUrl + "&t=" + Date.now());
    if(!r.ok) throw new Error('bad');
    const data = await r.json();
    let title = "";
    if(data.icestats && data.icestats.source){
      const src = Array.isArray(data.icestats.source) ? data.icestats.source.find(s => s.listenurl && s.listenurl.includes("/trela233")) : data.icestats.source;
      title = src && src.title ? src.title : "";
    }
    title = (title||"").trim();
    if(title) title = decodeGreek(title);
    return title || originalRadioName;
  } catch(e){ return originalRadioName; }
}

let zenoEventSource = null;
let zenoPollInterval = null;
function startZenoSSE(){
  stopZeno();
  const url = STREAMS.backup.zenoMetaUrl(STREAMS.backup.zenoStationId);
  try {
    zenoEventSource = new EventSource(url);
    zenoEventSource.onmessage = (ev) => {
      try {
        const d = JSON.parse(ev.data);
        const title = (d && d.streamTitle) ? String(d.streamTitle).trim() : "";
        nowPlayingEl.textContent = title && title.length ? title : originalRadioName;
      } catch(e){}
    };
    zenoEventSource.onerror = () => { stopZeno(); startZenoPolling(); };
  } catch(e){ startZenoPolling(); }
}
function startZenoPolling(){
  stopZeno();
  const fetchOnce = async () => {
    try{
      const r = await fetch(STREAMS.backup.zenoMetaUrl(STREAMS.backup.zenoStationId) + "?t=" + Date.now());
      const data = await r.json();
      const title = data && data.streamTitle ? String(data.streamTitle).trim() : "";
      nowPlayingEl.textContent = title && title.length ? title : originalRadioName;
    } catch(e){ nowPlayingEl.textContent = originalRadioName; }
  };
  fetchOnce();
  zenoPollInterval = setInterval(fetchOnce, 10000);
}
function stopZeno(){
  if(zenoEventSource){ try{ zenoEventSource.close(); }catch(e){} zenoEventSource = null; }
  if(zenoPollInterval){ clearInterval(zenoPollInterval); zenoPollInterval = null; }
}

async function updateNowPlayingImmediate(){
  if(isLive){ nowPlayingEl.textContent = await fetchLiveTitle(); stopZeno(); }
  else { startZenoSSE(); }
}

async function playStream(url, live=true){
  audio.pause(); audio.src = ""; isLive = live;
  
  // ΕΜΦΑΝΙΣΗ MODAL ΚΑΙ ΜΗΝΥΜΑΤΟΣ
  modalText.textContent = live ? "Φόρτωση live streaming" : "παρακαλώ περιμένετε φόρτωση servers";
  loadingModal.style.display = "flex";

  statusEl.textContent = live ? "Φόρτωση Live Streaming" : "Φόρτωση, παρακαλώ περιμένετε";
  statusEl.className = "loading"; audio.src = url;
  try {
    await audio.play();
    loadingModal.style.display = "none"; // ΚΛΕΙΣΙΜΟ MODAL ΟΤΑΝ ΠΑΙΞΕΙ
    statusEl.textContent = live ? "ON AIR RADIO EROTAS" : " ON AIR (Fallback)";
    statusEl.className = live ? "onair" : "offair";
    updateNowPlayingImmediate();
  } catch(e){
    if(live) playStream(STREAMS.backup.streamUrl, false);
    else { 
        modalText.textContent = "παρακαλώ περιμένετε φόρτωση servers"; // ΠΑΡΑΜΕΝΕΙ ΤΟ MODAL ΑΝ ΑΠΟΤΥΧΟΥΝ ΟΛΑ
        statusEl.textContent = "παρακαλώ περιμένετε φόρτωση server"; 
        statusEl.className = "offair"; 
    }
  }
}

function startAutoRetry(){
  if(window._playerRetryInterval) return;
  window._playerRetryInterval = setInterval(async () => {
    if(!isPlaying) return;
    if(!isLive){
      const test = new Audio(); test.crossOrigin = "anonymous"; test.src = STREAMS.live.streamUrl;
      try{ await test.play(); test.pause(); test.src = ""; playStream(STREAMS.live.streamUrl, true); } catch(e){}
    } else {
      if(audio.paused || audio.ended){ playStream(STREAMS.backup.streamUrl, false); }
    }
  }, retryIntervalMs);
}

let rotation = 0;
function rotateButton(){
  if(isPlaying){
    rotation += 0.2;
    visualizerCircle.style.transform = `scale(1.0) rotate(${rotation}deg)`; 
  }
  requestAnimationFrame(rotateButton);
}
requestAnimationFrame(rotateButton);

btn.addEventListener('click', () => {
  if(isPlaying){
    audio.pause(); btn.textContent = "Play"; statusEl.textContent = "Παύση"; statusEl.className = "offair"; isPlaying = false; stopZeno();
    loadingModal.style.display = "none";
  } else {
    btn.textContent = "Pause"; setupAudioNodes(); playStream(STREAMS.live.streamUrl, true); isPlaying = true; startAutoRetry();
  }
});

audio.addEventListener('error', () => { if(isLive) playStream(STREAMS.backup.streamUrl, false); });
audio.addEventListener('ended', () => { if(isLive) playStream(STREAMS.backup.streamUrl, false); });

setInterval(() => { if(isLive && isPlaying) fetchLiveTitle().then(t => { if(isLive) nowPlayingEl.textContent = t; }); }, 15000);

window.addEventListener('load', () => {
  const isInIframe = window.self !== window.top;
  const hasReferrer = document.referrer && !document.referrer.includes(location.hostname);
  if (isInIframe || hasReferrer) {
    setTimeout(() => {
      if (!isPlaying) {
        btn.textContent = "Pause";
        statusEl.textContent = "Φόρτωση...";
        statusEl.className = "loading";
        setupAudioNodes();
        playStream(STREAMS.live.streamUrl, true);
        isPlaying = true;
        startAutoRetry();
      }
    }, 300);
  }
});

let _breathRunning = false;
function computeLevelFromFrequencyData() {
  if (!analyser || !dataArray) return 0;
  analyser.getByteFrequencyData(dataArray);
  const N = Math.floor(dataArray.length * 0.6);
  let sum = 0;
  for (let i = 0; i < N; i++) sum += dataArray[i];
  return (sum / N) / 255;
}

function lerp(a,b,t){ return a + (b-a)*t; }

function startButtonBreath(){
  if(_breathRunning) return;
  _breathRunning = true;
  let smooth = 0;
  function step(){
    let target = 0.1;
    if(analyser && dataArray){ const lvl = computeLevelFromFrequencyData(); target = Math.max(target, lvl); }
    smooth = lerp(smooth, target, 0.3);
    const size = Math.round(lerp(20, 120, smooth)) + "px";
    visualizerCircle.style.setProperty('--glow-size', size);
    const scale = 1 + (smooth * 0.25);
    visualizerCircle.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
</script>
</body>
</html>

